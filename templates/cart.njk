{% extends "index.njk" %}

{% block body %}
<form action="/checkout" method="post">
    <div class="container">
        <div class="row">
            <div class="col-md-7 table">
                <table>
                    <div class="showPopup" data-result = "{{message}}">
                        <p class="message"></p>
                    </div>
                    <tr>
                        <th>Product</th>
                        <th>Description</th>
                        <th class="unitPrice">Unit price</th>
                        <th>Quantity</th>
                        <th>Price</th>
                    </tr>
                    {% for item in cart.items %}
                    <tr>
                        <td>{{ item.name }}</td>
                        <td>{{ item.description }}</td>
                        <td class="{{ item.name }}">{{ item.price }}</td>
                        <td><input name="{{ item.name }}" data-price="{{item.price}}" type="number" style="width: 60px" min="0" value="{{ item.quantity }}"></td>
                        <td class="price"></td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
            <div class="col-md-5 table orderSummary">
                <table>
                    <tr>
                        <th>Order summary</th>
                        <th></th>
                    </tr>
                    <tr>
                        <td>Subtotal</td>
                        <td class="subtotal"></td>
                    </tr>
                    <tr>
                        <td>Shipping</td>
                        <td class="shipping"></td>
                    </tr>
                    <tr>
                        <td>Total</td>
                        <td class="total"></td>
                    </tr>
                </table>
                <p>This is the subtotal, shipping and total amount</p>
                    <button type="submit">Proceed to Checkout</button>
                <button type="button" onclick="location.href='/results'">Shop some more</button>
            </div>
        </div>
    </div>
</form>
{% endblock %}



{% block script %}

    <script>
        var message = $(".showPopup");
        pMessage = message.data("result");
        if(pMessage === "your cart is empty"){
            message.addClass("active");
            $(".message").html(pMessage);
            setInterval(revert, 3000);
            function revert () {
                $(".showPopup").removeClass("active");
            }

        } else {
            message.css("display", "none");
        }

        const defaultShipping = 20;
        var shipping = $(".shipping");
        var inputs = $("input");
        var total = $(".total")

        $(inputs).each( function (i, input) {
                updatePrice(input);
        });

        var subtotal = $(".subtotal");
        var prices = $(".price");

        updateSubtotal();

        inputs.on("change", function(e) {

            updatePrice(e.target);

            var amount = e.target.parentElement.nextElementSibling.innerText;
            var trimAmount= amount.substr(amount.indexOf("$") + 1);

            updateSubtotal();

            $.post("/cart", { //first argument is the route
                item: e.target.name, //second argument is the data to post to server
                quantity: e.target.value
            }, function(data) { //third argument is a call back that gives the data retrieved from the server
                var totalCartItems = data.items.reduce((previous, current) => previous + current.quantity, 0);
                $(".cartItem").html(totalCartItems);
            })


        });

        function updatePrice(input) {
            var unitPrice = input.dataset.price;
            var cartQuantity = input.value;
            var price = $(input).parent().next();
            var calc = formatCurrency(parseInt(cartQuantity) * parseInt(unitPrice));
            price.html(calc);
        }

        function updateSubtotal() {
            var subtotalPrice = 0;

            $(prices).each( function (i, price) {
                var amount = price.innerText;
                var trimAmount= amount.substr(amount.indexOf("$") + 1);
                subtotalPrice += parseInt(trimAmount);
            });

            subtotal.html(formatCurrency(subtotalPrice));

            updateShipping(subtotalPrice);
        }

        function updateShipping (subtotalPrice) {
            if (subtotalPrice > 200) {
                shipping.html("FREE for purchases over $200");
                total.html(formatCurrency(subtotalPrice));
            } else {
                shipping.html(formatCurrency(defaultShipping));
                total.html(formatCurrency(subtotalPrice + defaultShipping));
            }
        }




    </script>

{% endblock %}